{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - ThermaSense{% endblock %}

{% block content %}
<div class="row">
    <!-- Statistics Cards -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-uppercase mb-1" style="opacity: 0.9;">Total Rooms</h6>
                    <h2 class="mb-0">{{ total_rooms }}</h2>
                </div>
                <div>
                    <i class="bi bi-buildings"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-uppercase mb-1" style="opacity: 0.9;">Occupied Now</h6>
                    <h2 class="mb-0">{{ occupied_rooms }}</h2>
                </div>
                <div>
                    <i class="bi bi-people-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-uppercase mb-1" style="opacity: 0.9;">Heating Active</h6>
                    <h2 class="mb-0">{{ heated_rooms }}</h2>
                </div>
                <div>
                    <i class="bi bi-thermometer-high"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-uppercase mb-1" style="opacity: 0.9;">CO₂ Saved</h6>
                    <h2 class="mb-0">{{ total_co2_saved_kg|floatformat:1 }} kg</h2>
                </div>
                <div>
                    <i class="bi bi-cloud-arrow-down"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Main Dashboard Content -->
    <div class="col-lg-8">
        <!-- Room Map -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-map me-2"></i>Room Status Map</h5>
                <div class="d-flex">
                    <span class="badge bg-success me-2">Occupied</span>
                    <span class="badge bg-warning me-2">Heating</span>
                    <span class="badge bg-secondary">Idle</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for room in rooms %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card room-card
                            {% if room.heating_status and room.is_occupied %}room-status-recommendation
                            {% elif room.is_occupied %}room-status-occupied
                            {% elif room.heating_status %}room-status-heating
                            {% else %}room-status-idle{% endif %}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">
                                        <i class="bi
                                            {% if room.is_occupied %}bi-people-fill text-success
                                            {% elif room.heating_status %}bi-thermometer-high text-warning
                                            {% else %}bi-thermometer-low text-secondary{% endif %} me-2"></i>
                                        {{ room.name }}
                                    </h6>
                                    <span class="badge {% if room.heating_status %}bg-warning{% else %}bg-success{% endif %}">
                                        {{ room.target_temperature }}°C
                                    </span>
                                </div>

                                <p class="card-text small text-muted mb-2">
                                    <i class="bi bi-rulers me-1"></i> {{ room.area }} m²
                                    <span class="mx-2">|</span>
                                    <i class="bi bi-bricks me-1"></i> {{ room.get_wall_material_display }}
                                </p>

                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <button class="btn btn-sm {% if room.heating_status %}btn-danger{% else %}btn-success{% endif %}"
                                            onclick="toggleHeating('{{ room.id }}', '{{ room.heating_status }}')">
                                        <i class="bi bi-power"></i>
                                        {% if room.heating_status %}Turn Off{% else %}Turn On{% endif %}
                                    </button>
                                    <a href="{% url 'room_detail' room.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-info-circle"></i> Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-door-closed display-1 text-muted"></i>
                        <h4 class="mt-3 text-muted">No rooms found</h4>
                        <p class="text-muted">Add rooms from the admin panel to get started.</p>
                        <a href="/admin/core/room/add/" class="btn btn-thermasense">
                            <i class="bi bi-plus-circle"></i> Add First Room
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Savings Chart -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Energy Savings Overview</h5>
            </div>
            <div class="card-body">
                <canvas id="savingsChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Recommendations -->
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Smart Recommendations</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% for rec in recommendations %}
                <div class="alert alert-warning alert-custom mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">{{ rec.room.name }}</h6>
                        <span class="badge bg-danger">Priority: {{ rec.get_priority_display }}</span>
                    </div>
                    <p class="small mb-2">{{ rec.message }}</p>
                    <p class="mb-2"><strong>{{ rec.recommended_action }}</strong></p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-lightning"></i> Save {{ rec.estimated_savings|floatformat:2 }} kWh
                        </small>
                        <form method="post" action="{% url 'toggle_heating' rec.room.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success">
                                <i class="bi bi-check-circle"></i> Apply
                            </button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4">
                    <i class="bi bi-check2-circle display-4 text-success"></i>
                    <p class="mt-3 text-muted">All systems optimized!</p>
                    <p class="small text-muted">No recommendations at this time.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Weather Widget -->
        <div class="card mb-4 weather-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-cloud-sun"></i> Current Weather</h5>
                    <span class="badge bg-light text-dark">
                        <i class="bi bi-clock"></i> Updated {{ weather.cached_at|timesince }} ago
                    </span>
                </div>

                <div class="temperature-display mb-3">{{ weather.temperature|floatformat:1 }}°C</div>

                <div class="row text-center">
                    <div class="col-6">
                        <div class="mb-2">
                            <i class="bi bi-moisture"></i>
                        </div>
                        <div class="small">Humidity</div>
                        <div class="fw-bold">{{ weather.humidity }}%</div>
                    </div>
                    <div class="col-6">
                        <div class="mb-2">
                            <i class="bi bi-wind"></i>
                        </div>
                        <div class="small">Wind Speed</div>
                        <div class="fw-bold">{{ weather.wind_speed }} m/s</div>
                    </div>
                </div>

                <div class="mt-3">
                    <span class="badge bg-light text-dark">{{ weather.description|title }}</span>
                </div>
            </div>
        </div>
        <!-- Gamification Card -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Energy Leaderboard</h5>
            </div>
            <div class="card-body">
                <!-- Daily Points -->
                <div class="text-center mb-4">
                    <div class="display-4 text-success">1,250</div>
                    <small class="text-muted">Your points today</small>
                    <div class="progress mt-2" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: 65%">65% to next level</div>
                    </div>
                </div>

                <!-- Leaderboard -->
                <h6 class="mb-3"><i class="bi bi-trophy-fill text-warning"></i> Top Departments</h6>
                <div class="leaderboard mb-4">
                    {% for leader in leaders %}
                    <div class="leader-item d-flex justify-content-between align-items-center mb-2 p-2
                                {% if forloop.first %}bg-warning bg-opacity-10{% endif %}">
                        <div class="d-flex align-items-center">
                            <span class="badge
                                {% if forloop.first %}bg-warning{% elif forloop.counter == 2 %}bg-secondary{% elif forloop.counter == 3 %}bg-danger{% else %}bg-light text-dark{% endif %}
                                me-2">
                                {{ forloop.counter }}
                            </span>
                            <div>
                                <strong>{{ leader.name }}</strong>
                                <div class="small text-muted">{{ leader.description }}</div>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">{{ leader.points }} pts</div>
                            <div class="small text-success">+{{ leader.savings }} kWh</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Daily Challenge -->
                <div class="daily-challenge p-3 bg-light rounded">
                    <h6><i class="bi bi-star-fill text-warning"></i> Today's Challenge</h6>
                    <p class="mb-2">Optimize heating in 3 rooms with high energy waste</p>
                    <div class="progress mb-2">
                        <div class="progress-bar" style="width: 66%">2/3 completed</div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Reward: 500 points + "Energy Hero" badge</small>
                        <button class="btn btn-sm btn-success" onclick="claimReward()">
                            <i class="bi bi-gift"></i> Claim
                        </button>
                    </div>
                </div>

                <!-- Achievements -->
                <div class="mt-3">
                    <h6><i class="bi bi-award"></i> Your Achievements</h6>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> Early Saver
                        </span>
                        <span class="badge bg-info">
                            <i class="bi bi-tree"></i> Eco Warrior
                        </span>
                        <span class="badge bg-warning">
                            <i class="bi bi-lightning"></i> Energy Optimizer
                        </span>
                        <span class="badge bg-secondary">
                            <i class="bi bi-star"></i> Weekly Champion
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3"><i class="bi bi-calculator me-2"></i>Today's Savings</h5>

                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <span>Energy Saved</span>
                    <span class="fw-bold text-success">{{ total_savings_kwh|floatformat:2 }} kWh</span>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <span>CO₂ Reduction</span>
                    <span class="fw-bold text-info">{{ total_co2_saved_kg|floatformat:2 }} kg</span>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <span>Cost Savings</span>
                    <span class="fw-bold text-primary">${{ total_money_saved|floatformat:2 }}</span>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <span>Rooms Optimized</span>
                    <span class="fw-bold">{{ recommendations|length }}</span>
                </div>

                <div class="mt-4">
                    <a href="{% url 'reports' %}" class="btn btn-thermasense w-100">
                        <i class="bi bi-file-earmark-text"></i> View Detailed Reports
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize savings chart
    document.addEventListener('DOMContentLoaded', function() {
        var ctx = document.getElementById('savingsChart').getContext('2d');
        var savingsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Energy Saved (kWh)',
                    data: [12, 19, 8, 15, 22, 18, 24],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'CO₂ Reduced (kg)',
                    data: [4.8, 7.6, 3.2, 6.0, 8.8, 7.2, 9.6],
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Savings'
                        }
                    }
                }
            }
        });
    });

    // Gamification functions
    function claimReward() {
        // Show success message
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            <i class="bi bi-gift-fill"></i> Reward claimed! +500 points & "Energy Hero" badge unlocked!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);

        // Update points display
        const pointsElement = document.querySelector('.display-4');
        const currentPoints = parseInt(pointsElement.textContent.replace(/,/g, ''));
        pointsElement.textContent = (currentPoints + 500).toLocaleString();

        // Update progress bar
        const progressBar = document.querySelector('.progress-bar');
        progressBar.style.width = '100%';
        progressBar.textContent = 'Level Up!';

        // Add new badge
        const badgesContainer = document.querySelector('.d-flex.flex-wrap.gap-2');
        const newBadge = document.createElement('span');
        newBadge.className = 'badge bg-danger';
        newBadge.innerHTML = '<i class="bi bi-fire"></i> Energy Hero';
        badgesContainer.appendChild(newBadge);

        // Remove notification after 5 seconds
        setTimeout(() => notification.remove(), 5000);
    }

    // Update points every minute (simulation)
    setInterval(() => {
        const pointsElement = document.querySelector('.display-4');
        const currentPoints = parseInt(pointsElement.textContent.replace(/,/g, ''));
        const increment = Math.floor(Math.random() * 10) + 1;
        pointsElement.textContent = (currentPoints + increment).toLocaleString();
    }, 60000);

    // Add toggleHeating function if needed
    function toggleHeating(roomId, currentStatus) {
        // Your heating toggle logic here
        console.log('Toggling heating for room:', roomId, 'Current status:', currentStatus);
    }
</script>
{% endblock %}