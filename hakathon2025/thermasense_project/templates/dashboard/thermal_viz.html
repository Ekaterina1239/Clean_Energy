{% extends 'base.html' %}

{% block title %}Thermal Visualization - ThermaSense{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-thermometer-sun me-2"></i>Thermal Visualization</h2>
        <p class="text-muted">Real-time heat distribution across campus</p>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="toggleHeatMap()">
                <i class="bi bi-fire"></i> Toggle Heat Map
            </button>
            <button class="btn btn-outline-secondary" onclick="resetView()">
                <i class="bi bi-arrow-clockwise"></i> Reset View
            </button>
        </div>
    </div>
</div>

<!-- Building Visualization -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-building me-2"></i>Campus Thermal Map</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-lg-8">
                <!-- 3D Building Visualization -->
                <div class="building-visualization" id="thermalViz">
                    <!-- Building Structure -->
                    <div class="building">
                        <!-- Main Building -->
                        <div class="floor" id="floor1">
                            <div class="room hot" data-room="101" style="left: 10%; top: 20%;">
                                <div class="room-label">101</div>
                                <div class="temp-indicator">22°C</div>
                                <div class="heat-waves"></div>
                            </div>
                            <div class="room optimal" data-room="102" style="left: 40%; top: 20%;">
                                <div class="room-label">102</div>
                                <div class="temp-indicator">20°C ✓</div>
                            </div>
                            <div class="room cold" data-room="103" style="left: 70%; top: 20%;">
                                <div class="room-label">103</div>
                                <div class="temp-indicator">18°C</div>
                            </div>
                        </div>
                        
                        <div class="floor" id="floor2">
                            <div class="room optimal" data-room="201" style="left: 10%; top: 50%;">
                                <div class="room-label">201</div>
                                <div class="temp-indicator">21°C ✓</div>
                            </div>
                            <div class="room hot" data-room="202" style="left: 40%; top: 50%;">
                                <div class="room-label">202</div>
                                <div class="temp-indicator">23°C</div>
                                <div class="heat-waves"></div>
                            </div>
                            <div class="room optimal" data-room="203" style="left: 70%; top: 50%;">
                                <div class="room-label">203</div>
                                <div class="temp-indicator">20°C ✓</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="thermal-legend">
                        <div class="legend-item">
                            <span class="color-box hot"></span>
                            <span>Hot (>21°C)</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-box optimal"></span>
                            <span>Optimal (19-21°C)</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-box cold"></span>
                            <span>Cold (<19°C)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <!-- Room Details -->
                <div class="room-details-card">
                    <h5 class="mb-3"><i class="bi bi-info-circle"></i> Selected Room Details</h5>
                    <div id="roomDetails">
                        <p class="text-muted">Click on a room to see details</p>
                    </div>
                    
                    <hr>
                    
                    <!-- Statistics -->
                    <div class="mt-3">
                        <h6>Floor Statistics</h6>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <small>Avg Temperature</small>
                                <div class="fw-bold">20.5°C</div>
                            </div>
                            <div class="stat-item">
                                <small>Rooms Heated</small>
                                <div class="fw-bold">4/6</div>
                            </div>
                            <div class="stat-item">
                                <small>Energy Usage</small>
                                <div class="fw-bold text-success">-15%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    <div class="mt-3">
                        <h6>Optimization Tips</h6>
                        <div class="alert alert-warning small">
                            <i class="bi bi-lightbulb"></i>
                            Room 202 is overheated. Consider reducing temperature by 2°C.
                        </div>
                        <div class="alert alert-info small">
                            <i class="bi bi-lightbulb"></i>
                            Room 103 is below comfort level. Check heating system.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Temperature Timeline -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>24-Hour Temperature Trends</h5>
    </div>
    <div class="card-body">
        <canvas id="temperatureChart" height="100"></canvas>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Thermal Visualization Styles */
.building-visualization {
    position: relative;
    height: 500px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.building {
    position: relative;
    width: 100%;
    height: 100%;
}

.floor {
    position: absolute;
    width: 90%;
    height: 40%;
    left: 5%;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

#floor1 { top: 10%; }
#floor2 { top: 55%; }

.room {
    position: absolute;
    width: 25%;
    height: 70%;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.room:hover {
    transform: scale(1.05);
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.room.hot {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    border: 2px solid #ff4757;
}

.room.optimal {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    border: 2px solid #2ecc71;
}

.room.cold {
    background: linear-gradient(135deg, #3498db, #2980b9);
    border: 2px solid #3498db;
}

.room-label {
    font-weight: bold;
    color: white;
    font-size: 1.2rem;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

.temp-indicator {
    color: white;
    font-size: 0.9rem;
    margin-top: 5px;
    background: rgba(0,0,0,0.3);
    padding: 2px 8px;
    border-radius: 10px;
}

.heat-waves {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 6px;
    background: radial-gradient(circle, rgba(255,100,0,0.3) 0%, transparent 70%);
    animation: heatPulse 2s infinite;
    pointer-events: none;
}

@keyframes heatPulse {
    0% { transform: scale(0.8); opacity: 0.7; }
    100% { transform: scale(1.2); opacity: 0; }
}

.thermal-legend {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.9);
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 5px 0;
}

.color-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    margin-right: 10px;
}

.color-box.hot { background: #ff6b6b; }
.color-box.optimal { background: #2ecc71; }
.color-box.cold { background: #3498db; }

.room-details-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    height: 100%;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 10px;
}

.stat-item {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
}

.stat-item small {
    display: block;
    color: #6c757d;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Room Click Handler
document.querySelectorAll('.room').forEach(room => {
    room.addEventListener('click', function() {
        const roomId = this.getAttribute('data-room');
        const temp = this.querySelector('.temp-indicator').textContent;
        const isHot = this.classList.contains('hot');
        const isCold = this.classList.contains('cold');
        
        let status = 'Optimal';
        if (isHot) status = 'Overheated';
        if (isCold) status = 'Below Comfort';
        
        document.getElementById('roomDetails').innerHTML = `
            <h5>Room ${roomId}</h5>
            <p><strong>Temperature:</strong> ${temp}</p>
            <p><strong>Status:</strong> <span class="badge bg-${isHot ? 'danger' : isCold ? 'info' : 'success'}">${status}</span></p>
            <p><strong>Area:</strong> 45 m²</p>
            <p><strong>Wall Material:</strong> ${roomId.startsWith('1') ? 'Brick' : 'Concrete'}</p>
            <p><strong>Occupancy:</strong> ${Math.random() > 0.5 ? 'Currently Occupied' : 'Vacant'}</p>
            <div class="mt-3">
                <button class="btn btn-sm ${isHot ? 'btn-danger' : isCold ? 'btn-info' : 'btn-success'}">
                    <i class="bi bi-thermometer"></i> Adjust Temperature
                </button>
            </div>
        `;
        
        // Highlight selected room
        document.querySelectorAll('.room').forEach(r => r.style.boxShadow = '');
        this.style.boxShadow = '0 0 0 3px gold';
    });
});

// Temperature Chart
const ctx = document.getElementById('temperatureChart').getContext('2d');
const tempChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
        datasets: [
            {
                label: 'Room 101',
                data: [18, 17, 22, 23, 22, 20, 19],
                borderColor: '#ff6b6b',
                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                tension: 0.4
            },
            {
                label: 'Room 102 (Optimized)',
                data: [18, 18, 20, 20, 20, 19, 18],
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' }
        },
        scales: {
            y: {
                beginAtZero: false,
                title: { display: true, text: 'Temperature (°C)' }
            }
        }
    }
});

// Toggle Heat Map
function toggleHeatMap() {
    const waves = document.querySelectorAll('.heat-waves');
    waves.forEach(wave => {
        wave.style.display = wave.style.display === 'none' ? 'block' : 'none';
    });
    
    // Show notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        Heat map ${waves[0].style.display === 'none' ? 'disabled' : 'enabled'}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
}

function resetView() {
    document.querySelectorAll('.room').forEach(room => {
        room.style.boxShadow = '';
    });
    document.getElementById('roomDetails').innerHTML = 
        '<p class="text-muted">Click on a room to see details</p>';
}
</script>
{% endblock %}